<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WOSA Reports - Upload de Arquivos</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .wosa-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .upload-section {
            background: var(--white);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .upload-area {
            border: 2px dashed var(--gray-300);
            border-radius: var(--radius-lg);
            padding: 3rem;
            text-align: center;
            transition: all var(--transition-fast);
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: var(--primary-color);
            background: rgba(59, 130, 246, 0.05);
        }
        
        .upload-area.dragover {
            border-color: var(--primary-color);
            background: rgba(59, 130, 246, 0.1);
        }
        
        .upload-icon {
            font-size: 3rem;
            color: var(--gray-400);
            margin-bottom: 1rem;
        }
        
        .upload-text {
            font-size: var(--font-size-lg);
            color: var(--gray-600);
            margin-bottom: 0.5rem;
        }
        
        .upload-subtext {
            font-size: var(--font-size-sm);
            color: var(--gray-500);
        }
        
        .file-input {
            display: none;
        }
        
        .file-info {
            background: var(--gray-50);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin-top: 1rem;
            display: none;
        }
        
        .file-info.show {
            display: block;
        }
        
        .file-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .file-name {
            font-weight: 500;
            color: var(--gray-800);
        }
        
        .file-size {
            font-size: var(--font-size-sm);
            color: var(--gray-600);
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--gray-200);
            border-radius: var(--radius-sm);
            overflow: hidden;
            margin-top: 1rem;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width var(--transition-normal);
        }
        
        .status-section {
            background: var(--white);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .status-card {
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            text-align: center;
        }
        
        .status-number {
            font-size: var(--font-size-3xl);
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        .status-label {
            color: var(--gray-600);
            font-weight: 500;
        }
        
        .files-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .files-table th,
        .files-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .files-table th {
            background: var(--gray-100);
            font-weight: 600;
            color: var(--gray-700);
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-lg);
            font-size: var(--font-size-sm);
            font-weight: 500;
        }
        
        .status-badge.pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }
        
        .status-badge.processing {
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary-color);
        }
        
        .status-badge.completed {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }
        
        .status-badge.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error-color);
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-small {
            padding: 0.5rem 1rem;
            font-size: var(--font-size-sm);
            border-radius: var(--radius-sm);
        }
        
        .reports-section {
            background: var(--white);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            padding: 2rem;
        }
        
        .report-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .report-card {
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .report-card:hover {
            background: var(--gray-100);
            transform: translateY(-2px);
        }
        
        .report-number {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        .report-title {
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 0.5rem;
        }
        
        .report-description {
            font-size: var(--font-size-sm);
            color: var(--gray-600);
        }
    </style>
</head>
<body>
    <div class="wosa-container">
        <!-- Header -->
        <div class="section-header">
            <h1><i class="fas fa-chart-bar"></i> WOSA Reports System</h1>
            <p>Sistema de gerenciamento e análise de relatórios WOSA</p>
        </div>

        <!-- Upload Section -->
        <div class="upload-section">
            <h2><i class="fas fa-upload"></i> Upload de Arquivo JSON</h2>
            <p>Faça upload do arquivo JSON com os dados dos tópicos WOSA</p>
            
            <div class="upload-area" id="upload-area">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="upload-text">Arraste e solte o arquivo JSON aqui</div>
                <div class="upload-subtext">ou clique para selecionar um arquivo</div>
                <input type="file" id="file-input" class="file-input" accept=".json" />
            </div>
            
            <div class="file-info" id="file-info">
                <div class="file-details">
                    <span class="file-name" id="file-name"></span>
                    <span class="file-size" id="file-size"></span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div style="margin-top: 1rem;">
                    <button class="btn btn-primary" id="upload-btn" disabled>
                        <i class="fas fa-upload"></i> Processar Arquivo
                    </button>
                    <button class="btn btn-secondary" id="cancel-btn" style="display: none;">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </div>
        </div>

        <!-- Status Section -->
        <div class="status-section">
            <h2><i class="fas fa-tachometer-alt"></i> Status do Sistema</h2>
            
            <div class="status-grid">
                <div class="status-card">
                    <div class="status-number" id="total-files">0</div>
                    <div class="status-label">Arquivos Processados</div>
                </div>
                <div class="status-card">
                    <div class="status-number" id="total-topics">0</div>
                    <div class="status-label">Tópicos Identificados</div>
                </div>
                <div class="status-card">
                    <div class="status-number" id="pending-files">0</div>
                    <div class="status-label">Pendentes</div>
                </div>
                <div class="status-card">
                    <div class="status-number" id="completed-files">0</div>
                    <div class="status-label">Concluídos</div>
                </div>
            </div>

            <h3>Arquivos Recentes</h3>
            <table class="files-table" id="files-table">
                <thead>
                    <tr>
                        <th>Nome do Arquivo</th>
                        <th>Data de Upload</th>
                        <th>Status</th>
                        <th>Tópicos</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="files-tbody">
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                            <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                            Nenhum arquivo processado ainda
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Reports Section -->
        <div class="reports-section">
            <h2><i class="fas fa-file-alt"></i> Relatórios Disponíveis</h2>
            <p>Gere relatórios específicos baseados nos dados dos tópicos</p>
            
            <div class="report-types">
                <div class="report-card" onclick="generateReport(1)">
                    <div class="report-number">01</div>
                    <div class="report-title">Sem Produtor</div>
                    <div class="report-description">Identificar tópicos sem produtor</div>
                </div>
                
                <div class="report-card" onclick="generateReport(2)">
                    <div class="report-number">02</div>
                    <div class="report-title">Sem Consumidor</div>
                    <div class="report-description">Identificar tópicos sem consumidor</div>
                </div>
                
                <div class="report-card" onclick="generateReport(3)">
                    <div class="report-number">03</div>
                    <div class="report-title">+ 30 dias sem msg</div>
                    <div class="report-description">Tópicos com mais de 30 dias sem mensagem</div>
                </div>
                
                <div class="report-card" onclick="generateReport(4)">
                    <div class="report-number">04</div>
                    <div class="report-title">+ 60 dias sem msg</div>
                    <div class="report-description">Tópicos com mais de 60 dias sem mensagem</div>
                </div>
                
                <div class="report-card" onclick="generateReport(5)">
                    <div class="report-number">05</div>
                    <div class="report-title">+ 90 dias sem msg</div>
                    <div class="report-description">Tópicos com mais de 90 dias sem mensagem</div>
                </div>
                
                <div class="report-card" onclick="generateReport(6)">
                    <div class="report-number">06</div>
                    <div class="report-title">Mais de um produtor</div>
                    <div class="report-description">Tópicos com mais de um produtor</div>
                </div>
                
                <div class="report-card" onclick="generateReport(7)">
                    <div class="report-number">07</div>
                    <div class="report-title">Sem AC registrado</div>
                    <div class="report-description">Tópicos sem AC registrado no Vlad</div>
                </div>
                
                <div class="report-card" onclick="generateReport(8)">
                    <div class="report-number">08</div>
                    <div class="report-title">Não documentado</div>
                    <div class="report-description">Tópicos não documentados</div>
                </div>
                
                <div class="report-card" onclick="generateReport(9)">
                    <div class="report-number">09</div>
                    <div class="report-title">Alterados 30/60/90</div>
                    <div class="report-description">Tópicos alterados nos últimos dias</div>
                </div>
                
                <div class="report-card" onclick="generateReport(10)">
                    <div class="report-number">10</div>
                    <div class="report-title">Ambientes incorretos</div>
                    <div class="report-description">Tópicos com ambiente diferente de Dev/Prod/E2E</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-content">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Processando...</p>
        </div>
    </div>

    <script>
        class WOSAApp {
            constructor() {
                this.apiBaseUrl = 'http://localhost:8000/api/v1/wosa';
                this.selectedFile = null;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadFiles();
                this.updateStats();
            }

            setupEventListeners() {
                const uploadArea = document.getElementById('upload-area');
                const fileInput = document.getElementById('file-input');
                const uploadBtn = document.getElementById('upload-btn');
                const cancelBtn = document.getElementById('cancel-btn');

                // Drag and drop
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });

                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        this.handleFileSelect(files[0]);
                    }
                });

                // Click to select file
                uploadArea.addEventListener('click', () => {
                    fileInput.click();
                });

                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this.handleFileSelect(e.target.files[0]);
                    }
                });

                uploadBtn.addEventListener('click', () => {
                    this.uploadFile();
                });

                cancelBtn.addEventListener('click', () => {
                    this.cancelUpload();
                });
            }

            handleFileSelect(file) {
                if (!file.name.toLowerCase().endsWith('.json')) {
                    this.showToast('Por favor, selecione um arquivo JSON válido', 'error');
                    return;
                }

                this.selectedFile = file;
                this.showFileInfo(file);
            }

            showFileInfo(file) {
                const fileInfo = document.getElementById('file-info');
                const fileName = document.getElementById('file-name');
                const fileSize = document.getElementById('file-size');
                const uploadBtn = document.getElementById('upload-btn');

                fileName.textContent = file.name;
                fileSize.textContent = this.formatFileSize(file.size);
                fileInfo.classList.add('show');
                uploadBtn.disabled = false;
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            async uploadFile() {
                if (!this.selectedFile) return;

                try {
                    this.showLoading();
                    this.updateProgress(0);

                    const formData = new FormData();
                    formData.append('file', this.selectedFile);
                    formData.append('user_id', 'web_user');

                    const response = await fetch(`${this.apiBaseUrl}/upload`, {
                        method: 'POST',
                        body: formData
                    });

                    this.updateProgress(50);

                    if (response.ok) {
                        const result = await response.json();
                        this.updateProgress(100);
                        
                        this.showToast('Arquivo enviado com sucesso!', 'success');
                        
                        // Process the file
                        await this.processFile(result.id);
                        
                        this.resetUpload();
                        this.loadFiles();
                        this.updateStats();
                    } else {
                        const error = await response.json();
                        this.showToast(`Erro no upload: ${error.detail}`, 'error');
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    this.showToast('Erro no upload do arquivo', 'error');
                } finally {
                    this.hideLoading();
                }
            }

            async processFile(fileId) {
                try {
                    const response = await fetch(`${this.apiBaseUrl}/process/${fileId}`, {
                        method: 'POST'
                    });

                    if (response.ok) {
                        const result = await response.json();
                        this.showToast(`Arquivo processado: ${result.topics_processed} tópicos`, 'success');
                    } else {
                        const error = await response.json();
                        this.showToast(`Erro no processamento: ${error.detail}`, 'error');
                    }
                } catch (error) {
                    console.error('Processing error:', error);
                    this.showToast('Erro no processamento do arquivo', 'error');
                }
            }

            cancelUpload() {
                this.resetUpload();
            }

            resetUpload() {
                this.selectedFile = null;
                document.getElementById('file-info').classList.remove('show');
                document.getElementById('file-input').value = '';
                document.getElementById('upload-btn').disabled = true;
                document.getElementById('progress-fill').style.width = '0%';
            }

            updateProgress(percent) {
                document.getElementById('progress-fill').style.width = `${percent}%`;
            }

            async loadFiles() {
                try {
                    const response = await fetch(`${this.apiBaseUrl}/files`);
                    const files = await response.json();

                    this.renderFilesTable(files);
                } catch (error) {
                    console.error('Error loading files:', error);
                }
            }

            renderFilesTable(files) {
                const tbody = document.getElementById('files-tbody');
                
                if (files.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                                <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                                Nenhum arquivo processado ainda
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = files.map(file => `
                    <tr>
                        <td>${file.original_name}</td>
                        <td>${this.formatDate(file.upload_date)}</td>
                        <td>
                            <span class="status-badge ${file.status}">
                                <i class="fas fa-circle"></i>
                                ${this.getStatusText(file.status)}
                            </span>
                        </td>
                        <td>-</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-small btn-primary" onclick="app.viewFile(${file.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-small btn-secondary" onclick="app.downloadFile(${file.id})">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }

            getStatusText(status) {
                const statusMap = {
                    'pending': 'Pendente',
                    'processing': 'Processando',
                    'completed': 'Concluído',
                    'error': 'Erro'
                };
                return statusMap[status] || status;
            }

            formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('pt-BR', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            async updateStats() {
                try {
                    const response = await fetch(`${this.apiBaseUrl}/files`);
                    const files = await response.json();

                    const totalFiles = files.length;
                    const pendingFiles = files.filter(f => f.status === 'pending').length;
                    const completedFiles = files.filter(f => f.status === 'completed').length;

                    document.getElementById('total-files').textContent = totalFiles;
                    document.getElementById('pending-files').textContent = pendingFiles;
                    document.getElementById('completed-files').textContent = completedFiles;
                    document.getElementById('total-topics').textContent = '0'; // Will be updated when topics are loaded
                } catch (error) {
                    console.error('Error updating stats:', error);
                }
            }

            async generateReport(reportType) {
                try {
                    this.showLoading();

                    const response = await fetch(`${this.apiBaseUrl}/reports`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            report_type: reportType,
                            generated_by: 'web_user'
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        this.showToast(`Relatório ${reportType} gerado com sucesso!`, 'success');
                        // Here you could redirect to view the report or download it
                    } else {
                        const error = await response.json();
                        this.showToast(`Erro ao gerar relatório: ${error.detail}`, 'error');
                    }
                } catch (error) {
                    console.error('Report generation error:', error);
                    this.showToast('Erro ao gerar relatório', 'error');
                } finally {
                    this.hideLoading();
                }
            }

            viewFile(fileId) {
                // Implement file viewing functionality
                this.showToast('Visualização de arquivo em desenvolvimento', 'info');
            }

            downloadFile(fileId) {
                // Implement file download functionality
                this.showToast('Download de arquivo em desenvolvimento', 'info');
            }

            // Loading and toast methods
            showLoading() {
                document.getElementById('loading-overlay').classList.add('active');
            }

            hideLoading() {
                document.getElementById('loading-overlay').classList.remove('active');
            }

            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-${this.getToastIcon(type)}"></i>
                        <span>${message}</span>
                    </div>
                `;

                document.getElementById('toast-container').appendChild(toast);

                setTimeout(() => {
                    toast.remove();
                }, 5000);
            }

            getToastIcon(type) {
                const icons = {
                    success: 'check-circle',
                    error: 'exclamation-circle',
                    warning: 'exclamation-triangle',
                    info: 'info-circle'
                };
                return icons[type] || 'info-circle';
            }
        }

        // Global functions
        function generateReport(reportType) {
            app.generateReport(reportType);
        }

        // Initialize the application
        let app;
        document.addEventListener('DOMContentLoaded', () => {
            app = new WOSAApp();
        });
    </script>
</body>
</html>
